<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Get SnowMyScreen</title>
  <meta name="description" content="Get SnowMyScreen - Bring your Mac to life with gentle, customizable snowfall. Available for macOS 14.6+" />

  <!-- Favicons -->
  <link rel="apple-touch-icon" sizes="180x180" href="images/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="images/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="images/favicon/favicon-16x16.png">
  <link rel="manifest" href="images/favicon/site.webmanifest">

  <!-- Open Graph / Social Media Preview -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Get SnowMyScreen" />
  <meta property="og:description" content="Bring your Mac to life with gentle, customizable snowfall. Available for macOS 14.6+" />
  <meta property="og:image" content="https://snowmyscreen.app/images/preview.png" />
  <meta property="og:url" content="https://snowmyscreen.app/download" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Get SnowMyScreen" />
  <meta name="twitter:description" content="Bring your Mac to life with gentle, customizable snowfall. Available for macOS 14.6+" />
  <meta name="twitter:image" content="https://snowmyscreen.app/images/preview.png" />

  <!-- Google Font (Geist) -->
  <link href="https://fonts.googleapis.com/css?family=Geist:400,500,600&display=swap" rel="stylesheet">

  <!-- Your CSS -->
  <link rel="stylesheet" href="css/main.css">

  <style>
    /* Additional styles for /download page */
    .go-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem 1rem;
      text-align: center;
      max-width: 600px;
      margin: 0 auto;
    }

    .go-icon {
      width: 80px;
      height: 80px;
      margin-bottom: 1.5rem;
    }

    .go-headline {
      font-size: clamp(1.75rem, 5vw, 2.5rem);
      font-weight: 600;
      color: #003669;
      margin-bottom: 1rem;
      line-height: 1.2;
    }

    .go-instruction {
      font-size: 1.1rem;
      color: #003669;
      margin-bottom: 2rem;
      line-height: 1.5;
    }

    .go-steps {
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(0, 54, 105, 0.1);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      text-align: left;
    }

    .go-step {
      display: flex;
      align-items: flex-start;
      gap: 1rem;
      margin-bottom: 1rem;
      font-size: 0.95rem;
      color: #003669;
    }

    .go-step:last-child {
      margin-bottom: 0;
    }

    .go-step-number {
      background: #003669;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.9rem;
      flex-shrink: 0;
    }

    .go-step-text {
      flex: 1;
      padding-top: 0.25rem;
    }

    .go-buttons {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      width: 100%;
      margin-bottom: 1.5rem;
    }

    .go-button {
      background: black;
      color: white;
      padding: 0.875rem 1.5rem;
      border-radius: 999px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      font-weight: 500;
      border: none;
      cursor: pointer;
      font-family: Geist, sans-serif;
      transition: transform 0.2s ease, opacity 0.2s ease;
      width: 100%;
    }

    .go-button:active {
      transform: scale(0.98);
    }

    .go-button.secondary {
      background: transparent;
      color: #003669;
      border: 1px solid rgba(0, 54, 105, 0.3);
    }

    .go-button.secondary:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    .go-helper-text {
      font-size: 0.85rem;
      color: #003669;
      opacity: 0.7;
      margin-bottom: 1rem;
    }

    .redirect-container {
      display: none;
    }

    .redirect-container.active {
      display: block;
    }

    .interstitial-container {
      display: none;
    }

    .interstitial-container.active {
      display: block;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(0, 54, 105, 0.1);
      border-top-color: #003669;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 640px) {
      .go-steps {
        padding: 1.25rem;
      }

      .go-step {
        font-size: 0.9rem;
      }

      .go-button {
        padding: 0.75rem 1.25rem;
        font-size: 0.95rem;
      }
    }
  </style>
</head>

<body>

  <!-- Redirect Container (for non-TikTok browsers) -->
  <div class="go-container redirect-container" id="redirect-container">
    <img src="images/icon.png" class="go-icon" alt="SnowMyScreen icon">
    <div class="loading-spinner"></div>
    <h1 class="go-headline" data-i18n="go.redirecting">Redirecting to App Store...</h1>
    <p class="go-instruction" data-i18n="go.redirectMessage">You will be redirected automatically in a moment.</p>
    <a class="go-button" id="fallback-link" href="https://apps.apple.com/us/app/snowmyscreen/id6755106853" target="_blank" rel="noopener noreferrer" data-i18n="go.fallbackLink">
      If you are not redirected, tap here
    </a>
  </div>

  <!-- Interstitial Container (for TikTok in-app browser) -->
  <div class="go-container interstitial-container" id="interstitial-container">
    <img src="images/icon.png" class="go-icon" alt="SnowMyScreen icon">

    <h1 class="go-headline" data-i18n="go.openInSafari">Open in Safari to continue</h1>

    <p class="go-instruction" data-i18n="go.instructionText">TikTok blocks App Store links in its built-in browser</p>

    <div class="go-steps">
      <div class="go-step">
        <div class="go-step-number">1</div>
        <div class="go-step-text" data-i18n="go.step1">Tap the three dots (â‹¯) in the top right corner</div>
      </div>
      <div class="go-step">
        <div class="go-step-number">2</div>
        <div class="go-step-text" data-i18n="go.step2">Select "Open in browser" or "Open in Safari"</div>
      </div>
      <div class="go-step">
        <div class="go-step-number">3</div>
        <div class="go-step-text" data-i18n="go.step3">You'll be sent to the App Store automatically</div>
      </div>
    </div>

    <div class="go-buttons">
      <button class="go-button secondary" id="copy-button" data-i18n="go.copyLink">
        Copy link
      </button>
    </div>

    <p class="go-helper-text" data-i18n="go.helperText">After opening in Safari, you will be sent to the App Store automatically</p>
  </div>

  <!-- i18n -->
  <script src="js/language.js"></script>

  <!-- TikTok detection and redirect logic -->
  <script>
    (function() {
      'use strict';

      // App Store URLs
      const APP_STORE_URL = 'https://apps.apple.com/us/app/snowmyscreen/id6755106853';
      const APP_STORE_ITMS_URL = 'itms-apps://apps.apple.com/us/app/snowmyscreen/id6755106853';

      // Get current URL with query parameters
      const currentURL = window.location.href;
      const urlParams = new URLSearchParams(window.location.search);

      // Preserve query parameters
      function appendQueryParams(url) {
        if (urlParams.toString()) {
          const separator = url.includes('?') ? '&' : '?';
          return url + separator + urlParams.toString();
        }
        return url;
      }

      // Analytics tracking
      const analytics = {
        pageView: function(environment) {
          // Log page view with environment
          console.log('[Analytics] Page view:', { environment, url: currentURL, params: urlParams.toString() });

          // Here you would integrate with your analytics service (GA4, Plausible, etc.)
          // Example: gtag('event', 'page_view', { environment: environment });
        },

        trackEvent: function(eventName, data) {
          console.log('[Analytics] Event:', eventName, data);

          // Here you would integrate with your analytics service
          // Example: gtag('event', eventName, data);
        }
      };

      // TikTok in-app browser detection
      function isTikTokInAppBrowser() {
        const userAgent = navigator.userAgent || '';

        // Check for TikTok-specific user agent strings (case insensitive)
        const tiktokPatterns = [
          /musical_ly_/i,
          /BytedanceWebview/i,
          /TikTok/i,
          /TTWebView/i
        ];

        return tiktokPatterns.some(pattern => pattern.test(userAgent));
      }

      // Safari detection (iOS)
      function isSafariIOS() {
        const userAgent = navigator.userAgent || '';

        // Check if Safari on iOS (not TikTok or other in-app browsers)
        const isSafari = /Safari/i.test(userAgent) && !/Chrome|CriOS|FxiOS|EdgiOS/i.test(userAgent);
        const isIOS = /iPhone|iPad|iPod/i.test(userAgent);

        return isSafari && isIOS;
      }

      // Copy to clipboard functionality
      function copyToClipboard(text) {
        // Try modern clipboard API first
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text)
            .then(() => {
              analytics.trackEvent('copy_link_success', { method: 'clipboard_api' });
            })
            .catch(() => {
              // Fallback to older method
              fallbackCopy(text);
            });
        } else {
          fallbackCopy(text);
        }
      }

      // Fallback copy method
      function fallbackCopy(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
          document.execCommand('copy');
          analytics.trackEvent('copy_link_success', { method: 'execCommand' });
        } catch (err) {
          // If all else fails, show the URL so user can manually copy
          analytics.trackEvent('copy_link_failed', {});
          alert('Copy this link:\n\n' + text);
        }

        document.body.removeChild(textArea);
      }

      // Redirect to App Store (with Safari enhancement)
      function redirectToAppStore() {
        const appStoreURL = appendQueryParams(APP_STORE_URL);

        // Track redirect attempt
        analytics.trackEvent('redirect_attempt', {
          url: appStoreURL,
          isSafari: isSafariIOS()
        });

        // Safari-specific enhancement: try to open App Store app
        if (isSafariIOS()) {
          const itmsURL = appendQueryParams(APP_STORE_ITMS_URL);

          // Create a temporary iframe to attempt opening the App Store app
          const iframe = document.createElement('iframe');
          iframe.style.display = 'none';
          iframe.src = itmsURL;
          document.body.appendChild(iframe);

          // Fallback to HTTPS URL after a short delay if App Store app doesn't open
          setTimeout(() => {
            document.body.removeChild(iframe);
            window.location.href = appStoreURL;
          }, 800);
        } else {
          // Standard redirect for non-Safari browsers
          setTimeout(() => {
            window.location.href = appStoreURL;
          }, 300);
        }
      }

      // Main initialization
      function init() {
        const isTikTok = isTikTokInAppBrowser();
        const redirectContainer = document.getElementById('redirect-container');
        const interstitialContainer = document.getElementById('interstitial-container');
        const copyButton = document.getElementById('copy-button');
        const fallbackLink = document.getElementById('fallback-link');

        // Update URLs with query parameters
        const appStoreURL = appendQueryParams(APP_STORE_URL);
        if (fallbackLink) fallbackLink.href = appStoreURL;

        if (isTikTok) {
          // TikTok in-app browser detected - show interstitial
          analytics.pageView('tiktok_inapp');

          interstitialContainer.classList.add('active');

          // Copy button click handler
          if (copyButton) {
            copyButton.addEventListener('click', () => {
              analytics.trackEvent('copy_link_click', {});
              copyToClipboard(currentURL);
            });
          }

        } else {
          // Standard browser - auto redirect
          analytics.pageView('standard_browser');

          redirectContainer.classList.add('active');

          // Perform redirect
          redirectToAppStore();

          // Track fallback link clicks
          if (fallbackLink) {
            fallbackLink.addEventListener('click', () => {
              analytics.trackEvent('fallback_link_click', {});
            });
          }
        }
      }

      // Run on DOM ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }

    })();
  </script>

</body>
</html>
